---
title: "AK ASOS Avg Wind Speed Assessment"
output: word_document
fig_width: 8
fig_height: 2
---
### Summary

This is an RMarkdown document - it is an html document (can also be a Word or PDF document) generated by R, commonly used for reporting. It provides a great way to encapsulate the results/output of any analyses conducted in R, because it is compiled simultanesouly as commands are executed.

### Data

Given our visual assesment of the "intensity"" of hourly records taken by site, we determined that somewhere around 1980 would be a good cutoff point to select a 30-year period that might capture most of the data. I found that bumping that cutoff date up to 1985 will capture about 5 more sites than using 1980, depending on how many missing observations we care about per day. Tentatively, our selected sites are based on the following rules:  

* Period: 1985-01-01 to 2015-01-01
* Fewer than 20% of days during this period having fewer than 6 hourly observations.

Here is the map of those sites:
```{r setup, message = FALSE, warning = FALSE, echo = FALSE}
library(data.table)
library(dplyr)
library(ggplot2)
library(lubridate)
library(changepoint)
library(trend)

### Recorded data
#To get an idea of which sites we want to include, I've been working on this inventory. A logical first step in this is #simply assessing the amount of successful records. I've preprocessed the data used here to contain only one recording #for each hour, and we can look at how many sites we get based on a range of cutoff criteria for "successful" days (> #bservations in a day) and proportion of successful days within various 30-year periods.

workdir <- file.path("C:/Users/Keal/Desktop/IARC/Wind_Climatology/")
datadir <- file.path(workdir, "data")
figdir <- file.path(workdir, "figures")

asos_daily_path <- file.path(datadir, "AK_ASOS_daily_allsites_speed_19700101_to_20190528.csv")
asos_daily <- fread(asos_daily_path)

select_stations_path <- file.path(datadir, "select_stations.Rds")
select_stations <- readRDS(select_stations_path)

#for(i in 1:11){
#  start_date <- ymd("1980-01-01") + years(i - 1)
#  end_date <- start_date + years(30)
#  asos_select_dates <- asos_daily %>% filter(date >= start_date & 
#                                     date <= end_date)
  
  
#}



# filter out sites that don't have observations spanning the period
#   based on proportion of "successful" days, i.e. days with 
#   some proportion of observations, p_succ
#n <- 6
#p_succ <- n/24
#p_tot <- 0.8
# number of potential sampling days
#n_days <- as.numeric(end_date - start_date)
#asos_select <- asos_select_dates %>% 
#  mutate(one = 1, succ = if_else(obs > p_succ, 1, 0))
#asos_select <- asos_select %>% group_by(stid) %>% 
#  summarise(prop_succ = sum(succ)/n_days)
#select_stations <- inner_join(asos_select, stations, by = "stid") %>%
#  filter(prop_succ > p_tot)

fig_path <- file.path(figdir, "AK_ASOS_avail_locations.png")

knitr::include_graphics(fig_path)
```


### Instrumentation Changes
So, to investigate the possibility of instrumentation changes evident in the data for our tenatively selected sites, below I've plotted the average monthly wind speeds. We'll consider the entire period we have data for because it might help us spot any changes in the time series more easily, but I've marked the tentative 1985-2015 cutoff in blue.  


  I also included a quick changepoint analysis here, assuming there are up to two changepoints in each series, and they must be significant at the level of 0.01 (results with 0.05 seemed a bit questionable). They are color coded as follows:  

* Purple (solid): changepoint in both mean and variance detected
* Red (dashed): changepoint in the mean detected
* Blue (dotted): changepoint in variance detected  
  
There is overlap between these in some cases
```{r speed, echo = FALSE, fig.height = 2, fig.width = 8, warning = FALSE, message = FALSE}


#asos_station_path <- file.path(datadir, "AK_ASOS_stations.csv")
#stations <- read.csv(asos_station_path, stringsAsFactors = FALSE)

stids <- select_stations$stid
date_labels <- c("1970", "1980", "1990", "2000", "2010", "2020")
date_breaks <- as.Date(c("1970-01-01", "1980-01-01", "1990-01-01", 
                 "2000-01-01", "2010-01-01", "2020-01-01"))
theme_set(theme_bw())
for(i in 1: length(stids)){
  asos_station <- asos_daily %>% filter(stid == stids[i]) %>%
    mutate(month = format(ymd(date), format = "%Y-%m"), one = 1) %>% 
    group_by(month) %>% summarise(avg_sped_mo = mean(avg_sped),
                                  #max_sped_mo = max(avg_sped),
                                  se = sd(avg_sped)/sqrt(sum(one))) %>%
    mutate(date = as.Date(paste0(month, "-01"),
                          origin = "1970-01-01"))
    
  value.ts <- ts(asos_station$avg_sped_mo, frequency = 12, 
                 start = c(1970, 1), end = c(2018, 12))  
  temp_m <- data.frame(cpt = numeric(), conf = numeric())
  #temp_v <- data.frame(cpt = numeric(), conf = numeric())
  alpha = 0.01
  mvar_binseg <- cpt.meanvar(value.ts, method = "BinSeg", 
                             Q = 2, pen.value = alpha, 
                             penalty = "Asymptotic")
  
  m_binseg <- cpt.mean(value.ts, method = "BinSeg", 
                             Q = 2, pen.value = alpha, 
                             penalty = "Asymptotic")
  
  var_binseg <- cpt.var(value.ts, method = "BinSeg", 
                             Q = 2, pen.value = alpha, 
                             penalty = "Asymptotic")
  #m_amoc <- cpt.mean(value.ts, method = "BinSeg", Q = 2)
  #v_amoc <- cpt.var(value.ts, method = "AMOC", class = FALSE)
  #if(mvar_amoc[2] > alpha){
  #  mvar_bs <- 0
  #} #else {
    #mvar_bs <- cpt.meanvar(value.ts, method = "BinSeg", Q = 2, class = FALSE)
  #}
  
  #l <- length(mvar_bs)
  #if(l > 1){
  #  if(l == 2){cp = mvar_bs[1]} else {cp = mvar_bs[1:2]}
  #} 
    
  mvar_cp <- cpts(mvar_binseg)  
  m_cp <- cpts(m_binseg)
  var_cp <- cpts(var_binseg)
  
  # modifier for determining cutoff
  # closer a dataset is to full amount of months, 
  # the higher the cutoff for displaying cp estimates
  mod <- dim(asos_station)[1]/588
  ul <- dim(asos_station)[1] - 20 * mod
  mvar_cp <- mvar_cp[mvar_cp < ul & mvar_cp > 20]
  m_cp <- m_cp[m_cp < ul & m_cp > 20]
  var_cp <- var_cp[var_cp < ul & var_cp > 30]

  p <- ggplot(asos_station, aes(date, avg_sped_mo, group = 1)) + geom_line() +
    xlab("") + ylab("Avg Speed (mph)") + xlim(ymd("1970-01-01"), ymd("2019-01-01")) + 
    #scale_x_date(date_labels = date_labels, breaks = date_breaks) + 
    ggtitle(stids[i]) + 
    geom_vline(xintercept = ymd("1985-01-01"), col = "grey", lty = 3, size = 1.25) + 
    geom_vline(xintercept = ymd("2015-01-01"), col = "grey", lty = 3, size = 1.25)
  
  if(length(mvar_cp) > 0){
    p <- p + geom_vline(xintercept = ymd(asos_station$date[mvar_cp]), 
                        col = "purple", size = 1.5)
  }
  if(length(m_cp) > 0){
    p <- p + geom_vline(xintercept = ymd(asos_station$date[m_cp]), 
                        col = "red", size = 1.25, lty = 2)
  }
  if(length(var_cp) > 0){
    p <- p + geom_vline(xintercept = ymd(asos_station$date[var_cp]), 
                        col = "blue", size = 1, lty = 3)
  }
  
  print(p)
  
}

#plots[[1]]

```

